apiVersion: v1
kind: ServiceAccount
metadata:
  name: dynamic_parameters
  namespace: dynamic_parameters
  annotations:
  labels:
      .InfrastructureLabels
      (strdict
        "gateway.networking.k8s.io/gateway-name" .Name
        "istio.io/gateway-name" .Name
  # Safe since 1.28: https://github.com/kubernetes/kubernetes/pull/117412
  ownerReferences:
  - apiVersion: gateway.networking.k8s.io/v1beta1
    kind: Gateway
    name: "dynamic_parameters"
    uid: "dynamic_parameters"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dynamic_parameters
  namespace: dynamic_parameters
  annotations:
  labels:
      .InfrastructureLabels
      (strdict
        "gateway.networking.k8s.io/gateway-name" .Name
        "istio.io/gateway-name" .Name
  ownerReferences:
  - apiVersion: gateway.networking.k8s.io/v1beta1
    kind: Gateway
    name: dynamic_parameters
    uid: "dynamic_parameters"
spec:
  selector:
    matchLabels:
      "dynamic_parameters": dynamic_parameters
  template:
    metadata:
      annotations:
          (omit .InfrastructureAnnotations "kubectl.kubernetes.io/last-applied-configuration" "gateway.istio.io/name-override" "gateway.istio.io/service-account" "gateway.istio.io/controller-version")
          (strdict "istio.io/rev" (.Revision | default "default"))
          (strdict
            "prometheus.io/path" "/stats/prometheus"
            "prometheus.io/port" "15020"
            "prometheus.io/scrape" "true"
      labels:
          (strdict
            "sidecar.istio.io/inject" "false"
            "service.istio.io/canonical-name" .DeploymentName
            "service.istio.io/canonical-revision" "latest"
           )
          .InfrastructureLabels
          (strdict
            "gateway.networking.k8s.io/gateway-name" .Name
            "istio.io/gateway-name" .Name
    spec:
      securityContext:
        sysctls:
        - name: net.ipv4.ip_unprivileged_port_start
          value: "0"
      serviceAccountName: dynamic_parameters
      containers:
      - name: istio-proxy
        image: "dynamic_parameters"
        image: "dynamic_parameters"
        resources:
        securityContext:
          # Safe since 1.22: https://github.com/kubernetes/kubernetes/pull/103326
          capabilities:
            drop:
            - ALL
          allowPrivilegeEscalation: false
          privileged: false
          readOnlyRootFilesystem: true
          runAsUser: dynamic_parameters
          runAsGroup: dynamic_parameters
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL
            add:
            - NET_BIND_SERVICE
          runAsUser: 0
          runAsGroup: 1337
          runAsNonRoot: false
          allowPrivilegeEscalation: true
          readOnlyRootFilesystem: true
        ports:
        - containerPort: 15021
          name: status-port
          protocol: TCP
        - containerPort: 15090
          protocol: TCP
          name: http-envoy-prom
        args:
        - proxy
        - router
        - --domain
        - $(POD_NAMESPACE).svc.dynamic_parameters
        - --proxyLogLevel
        - dynamic_parameters
        - --proxyComponentLogLevel
        - dynamic_parameters
        - --log_output_level
        - dynamic_parameters
        - --stsPort=dynamic_parameters
        - --log_as_json
        lifecycle:
        env:
        - name: PILOT_CERT_PROVIDER
          value: dynamic_parameters
        - name: CA_ADDR
          value: dynamic_parameters
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: INSTANCE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: SERVICE_ACCOUNT
          valueFrom:
            fieldRef:
              fieldPath: spec.serviceAccountName
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: ISTIO_CPU_LIMIT
          valueFrom:
            resourceFieldRef:
              resource: limits.cpu
        - name: PROXY_CONFIG
          value: |
        - name: ISTIO_META_POD_PORTS
          value: "[]"
        - name: ISTIO_META_APP_CONTAINERS
          value: ""
        - name: GOMEMLIMIT
          valueFrom:
            resourceFieldRef:
              resource: limits.memory
        - name: GOMAXPROCS
          valueFrom:
            resourceFieldRef:
              resource: limits.cpu
        - name: ISTIO_META_CLUSTER_ID
          value: "dynamic_parameters"
        - name: ISTIO_META_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: ISTIO_META_INTERCEPTION_MODE
          value: "dynamic_parameters"
        - name: ISTIO_META_NETWORK
          value: dynamic_parameters
        - name: ISTIO_META_WORKLOAD_NAME
          value: dynamic_parameters
        - name: ISTIO_META_OWNER
          value: "kubernetes://apis/apps/v1/namespaces/dynamic_parameters/deployments/dynamic_parameters"
        - name: ISTIO_META_MESH_ID
          value: "dynamic_parameters"
        - name: ISTIO_META_MESH_ID
          value: "dynamic_parameters"
        - name: TRUST_DOMAIN
          value: "dynamic_parameters"
        - name: dynamic_parameters
          value: "dynamic_parameters"
        - name: ISTIO_META_REQUESTED_NETWORK_VIEW
          value: dynamic_parameters
        startupProbe:
          failureThreshold: 30
          httpGet:
            path: /healthz/ready
            port: 15021
            scheme: HTTP
          initialDelaySeconds: 1
          periodSeconds: 1
          successThreshold: 1
          timeoutSeconds: 1
        readinessProbe:
          failureThreshold: 4
          httpGet:
            path: /healthz/ready
            port: 15021
            scheme: HTTP
          initialDelaySeconds: 0
          periodSeconds: 15
          successThreshold: 1
          timeoutSeconds: 1
        volumeMounts:
        - name: workload-socket
          mountPath: /var/run/secrets/workload-spiffe-uds
        - name: credential-socket
          mountPath: /var/run/secrets/credential-uds
        - name: gke-workload-certificate
          mountPath: /var/run/secrets/workload-spiffe-credentials
          readOnly: true
        - name: workload-certs
          mountPath: /var/run/secrets/workload-spiffe-credentials
        - mountPath: /var/run/secrets/istio
          name: istiod-ca-cert
        - mountPath: /var/lib/istio/data
          name: istio-data
        # SDS channel between istioagent and Envoy
        - mountPath: /etc/istio/proxy
          name: istio-envoy
        - mountPath: /var/run/secrets/tokens
          name: istio-token
        - name: istio-podinfo
          mountPath: /etc/istio/pod
      volumes:
        name: workload-socket
        name: credential-socket
      - name: gke-workload-certificate
        csi:
          driver: workloadcertificates.security.cloud.google.com
        name: workload-certs
      # SDS channel between istioagent and Envoy
      - emptyDir:
          medium: Memory
        name: istio-envoy
      - name: istio-data
      - name: istio-podinfo
        downwardAPI:
          items:
            - path: "labels"
              fieldRef:
                fieldPath: metadata.labels
            - path: "annotations"
              fieldRef:
                fieldPath: metadata.annotations
      - name: istio-token
        projected:
          sources:
          - serviceAccountToken:
              path: istio-token
              expirationSeconds: 43200
              audience: dynamic_parameters
      - name: istiod-ca-cert
        configMap:
          name: istio-ca-root-cert
      imagePullSecrets:
        - name: dynamic_parameters
---
apiVersion: v1
kind: Service
metadata:
  annotations:
  labels:
      .InfrastructureLabels
      (strdict
        "gateway.networking.k8s.io/gateway-name" .Name
        "istio.io/gateway-name" .Name
  name: dynamic_parameters
  namespace: dynamic_parameters
  ownerReferences:
  - apiVersion: gateway.networking.k8s.io/v1beta1
    kind: Gateway
    name: dynamic_parameters
    uid: dynamic_parameters
spec:
  ports:
  - name: dynamic_parameters
    port: dynamic_parameters
    protocol: TCP
    appProtocol: dynamic_parameters
  selector:
    "dynamic_parameters": dynamic_parameters
  loadBalancerIP: dynamic_parameters
  type: dynamic_parameters
---

---
